---
title: "Cruise Ships' Impact on NYC Air Quality"
subtitle: "Final Presentation, DATA 698 CUNY SPS"
author: "Alice Friedman"
institute: "CUNY School for Professional Studies"
date: "`r Sys.Date()`"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = T)
library(readr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(forecast)
library(scales)
library(ggcorrplot)
library(httr)
library(jsonlite)
library(tidyr)
library(forcats)
library(glmnet)
library(gridExtra)
library(stringr)
library(kableExtra)
library(caret)
library(leaps)
library(MASS)
```

## Introduction

- Air Pollution is responsible for an estimated 6.7 million annual premature deaths globally (WHO, 2022).
  
- Cruise ship emissions are a visible source of urban pollition in coastal cities, with increasing attention to mitigation strategies like the use of on-shore power while in port

- *Research Gap*: Lack of empirical analysis in the context of New York City, emphasizing the need for a data-driven approach.

## Study Area: Brooklyn Cruise Terminal

- Only terminal on the east coast with shore power system designed to reduce emissions

- Installed in 2016 at the cost of $21M

- Red Hook neighborhood has worst air quality in Brooklyn (NYC.gov, 2023)

- Policy Context: New York City considering local law Int. 1050, requiring cruise ships to use on-shore power by 2028 at all ports (including Manattan Cruise Terminal)

## Research Questions

-  What level of expected improvement in air quality can be expected as a result of improvements to New York City cruise ship terminals and proposed new regulations that will require all cruise ships to use on-shore power by 2028?

    - What feature set among available inputs will best predict air quality *in the absence of consideration of cruise ship inputs*? 

    - Does the inclusion of cruise ship features measurably improve these results?

## Literature Review

- Selection of PM 2.5 as a critical parameter due to its known health impacts and reliable measurement methods

- Methodological research included use of circular data (wind direction) and PM 2.5 readings from Purple Air

- Studies from Europe (Hrvoje, 2011; Ruiz-Guerra et al, 2019; Fabregat et al, 2021) and Canada (Poplawski et al, 2011) support cruise ship emissions as measurably impacting on-shore air quality, typically using linear regression

- No studies found to document this relationship in New York City, or using non-parametric methods to identify feature set

## Data Sources

- Weather and airquality data at the Port is taken from a Dyson Instruments weather station located adjacent to the Brooklyn Cruise Terminal

- Observations are taken in 15 minute increments, starting July 11, 2023

- Ship docking data is taken from Port of New York, hourly, and the EDC for information on whether ships can access the on-shore power or must use the generator (all ships outside of BCT use generators)

- Additional data taken from Purple Air sensor at Dyberry farm as a control for wildfire smoke

    - Also explored alternative method of using wood-smake adjusted AQI as a target

## Data Preparation

- Weather data features evaluated include temperature, dew point, heat bulb index, humidity, wind speed, wind direction, air pressure reported at average, low, and high as well as rain in inches

- Highly correlated weather features pruned to include only average value

- Wind direction converted to radians and then defined by the sine and cosine of theta to avoid correlation

- Cruise ship compatibility is taken from the EDC and extrapolated to ship dockings in July

- PM 2.5 levels from Purple Air corrected based on EPA 

- Weather data aggregated hourly (average value, except for rain which is summed) to join with cruise ship data and control sensor data from Purple Air

- Final data set has 17 features, 5 possible targets, and 3,396 observations across 141 days (some days contain more than 24 observations because there may be more than one ship present)

## Time Series

```{r load_data, message=FALSE, warning=FALSE}
#source("purple_pull.R") pulls from API and writes to csvs
source("cruise_dataprep.R") #loads CSV generated from worlshipny.org and merges with EDC info on shore power
source("PortSide_dataprep.R") #loads CSV aggregates as hourly data ("Dyson_hourly") and daily"
```

```{r join_data_hourly}
Dyberry <- read_csv("Dyberry.csv", show_col_types = FALSE ) #loads PM2.5 from purple air at Dyberry Farm

ship_cols <-c(
  "Ship_Presence","Terminal", "Line", "Generator"
)

drop_list <-c(
  "degrees_mean"
)

#Join PortSide NY data to purple air data to cruise ships data to create an hourly data frame
df_hourly <- left_join(Dyson_hourly, dplyr::select(Dyberry, local_datetime, PM2.5_corrected), by=c("hour" = "local_datetime"))  %>%     left_join(cruise_ships_hourly_wide, by=c("hour"="Hour")) %>%
  relocate(hour, all_of(starts_with(ship_cols))) %>% 
  dplyr::select(-all_of(drop_list)) %>%
  mutate( # add features related to hour and day of week
    dayofweek = wday(hour),
    hourofday = hour(hour),
    Ships = rowSums(across(contains("Ship")))
    )

  
write_csv(df_hourly, "Hourly_Joined.csv")
```

```{r join_daily}
df_daily <- Dyson_daily %>% 
  left_join(cruise_ships_daily_wide, by=c("date"="Date")) %>%
  relocate(date, any_of(ship_cols)) %>% 
  dplyr::select(-any_of(drop_list), -Hour) %>%
  mutate(
    dayofweek = wday(date),
    Ships = rowSums(across(contains("Ship")))
    ) 

write_csv(df_daily, "Daily_Joined.csv") 
```

```{r plot1}
p_time_PM <- ggplot(df_hourly %>% dplyr::filter(complete.cases(.))) +
  geom_line(aes(x=hour, y=PM2.5_Dyson, color="PM 2.5 Levels in Red Hook")) +
  geom_line(aes(x=hour, y=PM2.5_corrected, color="PM 2.5 Levels Upstate\n(Dyberry Farm Control)")) +
  scale_x_datetime(breaks = scales::date_breaks("1 month"), labels = date_format("%m %d")) +
  ylab("PM 2.5 (Parts Per Million)") + 
  xlab("Date") +
  theme(aspect.ratio = 1/4)+ 
  scale_color_manual(values = c("blue", "lightblue"), name = "Legend Title")

p_time_AQI <- ggplot(Dyson) +
  geom_line(aes(x=DateTime, y=AQI, color = "Actual AQI")) +  
  geom_line(aes(x=DateTime, y=AQI_adj, color = "Adjusted for Woodsmoke")) +  
  scale_x_datetime(breaks = scales::date_breaks("1 month"), labels = date_format("%m %d")) +
  ylab("AQI") + 
  xlab("Date") +
  theme(aspect.ratio = 1/4)+ 
  scale_color_manual(values = c("blue", "lightblue"), name = "Legend Title")

grid.arrange(p_time_AQI, p_time_PM, ncol=1)
```

## Data Exploration

```{r, warning=F, message=FALSE}


ggplot(df_hourly, aes(x=Ships, y = PM2.5_Dyson)) +
  geom_jitter(alpha=.4) + 
  geom_smooth(method="lm")

ggplot(df_hourly, aes(x=Ships, y = AQI_mean)) +
  geom_jitter(alpha=.4) + 
  geom_smooth(method="lm")


ggplot(df_hourly, aes(x=Generator, y = PM2.5_Dyson)) +
  geom_jitter(alpha=.4) + 
  geom_smooth(method="lm")

ggplot(df_hourly, aes(x=Generator, y = AQI_adj_mean)) +
  geom_jitter(alpha=.4) + 
  geom_smooth(method="lm")

```

```{r, eval=F, warning=F, message=FALSE}

ggplot(df_daily, aes(x=Ships, y = elevated_hours)) +
  geom_jitter(alpha=.4) + 
  geom_smooth(method="lm")

ggplot(df_daily, aes(x=Generator, y = elevated_hours)) +
  geom_jitter(alpha=.4) + 
  geom_smooth(method="lm")


ggplot(df_daily, aes(x=as.factor(TerminalBCT), y = elevated_hours)) +
  geom_jitter(alpha=.4) + 
  geom_smooth(method="lm")


```

## LASSO Regression

```{r LASSO_PM, message=FALSE, warning=FALSE}
lasso_data <- df_hourly%>% 
  drop_na() %>%
  dplyr::select(
  -AQI_mean, 
  -AQI_adj_mean,
  -PM10_mean,
  -PM1_mean, 
  -hour, 
  -Date
)

lasso_data_allships <-  df_daily %>%  
  drop_na() %>%
  dplyr::select(
  -AQI_mean,
  -PM10_mean,
  -PM1_mean,
  -AQI_adj_mean, -elevated_hours)
  
plot_lasso <- function(lasso_data, alpha, title="Lasso Feature Importance", sparse=F){
  # Sample data with a large feature set
set.seed(42)
X <- makeX(lasso_data %>%dplyr::select(-PM2.5_Dyson))
y <- lasso_data$PM2.5_Dyson
n <- length(y)
p <- length(X)


# Fit a Lasso model with cross-validation
cvfit <- cv.glmnet(X, y, alpha = alpha)  # alpha = 1 for Lasso, 0 for Ridge

# Find the optimal lambda (alpha) from cross-validation
best_lambda <- cvfit$lambda.1se

mse <- cvfit$cvm[match(best_lambda, cvfit$lambda)]

# Create a data frame for plotting
feature_importance <- as.data.frame(
as.matrix(coef(cvfit, best_lambda)
))

feature_importance$features <- rownames(feature_importance)

colnames(feature_importance) <- c("Coefficient", "Feature")

# Create a feature importance plot
p <- ggplot(feature_importance |> filter(Feature != "(Intercept)", Coefficient !=0), aes(x = reorder(Feature, -Coefficient), y = Coefficient)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = title, 
       subtitle = paste("MSE:", round(mse, 2))) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.margin = margin(0.5,0.5,0,0.5,"cm"),
    plot.title = element_text(size=10),
    plot.subtitle = element_text(size=10)) + coord_flip()

# print(cvfit)

return(p)
}

#hourly, no ships
p1 <- plot_lasso(lasso_data |>dplyr::select(-contains(c("Ship", "Line", "Terminal", "Generator"))), 1, "Hourly, No Ship")
#hourly, all ships
p2 <- plot_lasso(lasso_data, 1, "Lasso, Hourly, All Features", T)
#daily, no ships
p3 <- plot_lasso(lasso_data_allships |> dplyr::select(-contains(c("Ship", "Line", "Terminal", "Generator"))), 1, "Daily, No Ship Features")
#daily, all ships
p4 <- plot_lasso(lasso_data_allships, 1, "Daily, All Features")


#hourly, no ships
p5 <- plot_lasso(
  lasso_data |>dplyr::select(-contains(c("Ship", "Line", "Terminal", "Generator"))), 
  0, 
  "Hourly, No Ships")
#hourly, ships
p6 <- plot_lasso(lasso_data, 0, "Hourly, All Features")
#daily, no ships
p7 <- plot_lasso(
  lasso_data_allships |>dplyr::select(-contains(c("Ship", "Line", "Terminal", "Generator"))), 
  0
  , "Daily, No Ships")
#daily, all ships
p8 <- plot_lasso(lasso_data_allships, 0,  "Hourly, All Features")

plist <- list(p1,p2,p3,p4)
n <- length(plist)
nCol <- floor(sqrt(n))
do.call("grid.arrange", c(plist, ncol=nCol))
```


## Ridge Regression

```{r}
plist2 <- list(p5,p6)
n <- length(plist) 
nCol <- floor(sqrt(n))
do.call("grid.arrange", c(plist2, ncol=nCol)) 
```

## Elastic Net

```{r elasticnet, warning=FALSE, message=FALSE}
#adapted from https://rpubs.com/jmkelly91/881590
run_elastic <- function(lasso_data){
  set.seed(42)
  X <- makeX(lasso_data %>% dplyr::select(-PM2.5_Dyson))
  y <- lasso_data$PM2.5_Dyson

  models <- list()
  for (i in 0:20) {
    name <- paste0("alpha", i/20)
    models[[name]] <-
    cv.glmnet(X, y, type.measure="mse", alpha=i/20, 
              family="gaussian")
    }

    results <- data.frame()
  for (i in 0:20) {
    name <- paste0("alpha", i/20)
    
    mod <- models[[name]]
    
    ## Calculate the Mean Squared Error...
    mse <- mod$cvm[match(mod$lambda.1se, mod$lambda)]
    
    ## Store the results
    temp <- data.frame(alpha=i/20, mse=mse, name=name)
    results <- rbind(results, temp)
  }

plot(results$alpha, results$mse, ylim = c(0,50),
        main="Elastic Net Turning for Alpha", 
        xlab="Alpha",
        ylab="Mean Squared Error"
        ) |> print()
}

run_elastic(lasso_data)
```

## Visualizing Impactful Features
```{r viz}
ggplot(df_hourly, aes(x=as.factor(`ShipViking Neptune`), y = PM2.5_Dyson)) +
  geom_jitter(alpha=.4) + 
  geom_smooth(method="lm")

ggplot(df_hourly, aes(x=`Temp_mean`, y = PM2.5_Dyson)) +
  geom_jitter(alpha=.4) + 
  geom_smooth(method="lm")

ggplot(df_hourly, aes(x=`Avg.Wind.Speed_mean`, y = PM2.5_Dyson)) +
  geom_jitter(alpha=.4) + 
  geom_smooth(method="lm")

```

```{r}
Ships <- df_hourly %>% dplyr::select(contains("Ship")) %>% names()

ps <- list(rep(NA, length(Ships)))

ship <- Ships[1]

  p <- ggplot(df_hourly, aes(x=as.factor(`ShipAnthem of the Seas`), y = PM2.5_Dyson)) +
  geom_jitter(alpha=.4) + 
  geom_smooth(method="lm")
```
